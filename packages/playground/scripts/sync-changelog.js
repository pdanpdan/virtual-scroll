import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const changelogPath = path.resolve(__dirname, '../../../CHANGELOG.md');
const outputPath = path.resolve(__dirname, '../pages/changelog/changelog-data.ts');

const content = fs.readFileSync(changelogPath, 'utf8');

const versions = [];
// Split by headers starting with # or ##
const sections = content.split(/^(?=# )|^(?=## )/m);

for (let section of sections) {
  section = section.trim();
  if (!section) {
    continue;
  }

  const lines = section.split('\n');
  const header = lines[ 0 ];

  const versionMatch = header.match(/(?:#|##) v?\[?(\d+\.\d+\.\d+)\]?(?:\(.*\))?(?: \((\d{4}-\d{2}-\d{2})\)| - (\d{4}-\d{2}-\d{2}))/);

  if (versionMatch) {
    const version = versionMatch[ 1 ];
    const date = versionMatch[ 2 ] || versionMatch[ 3 ];

    const currentVersion = {
      version,
      date,
      features: [],
      fixes: [],
    };

    let currentType = null;

    for (let i = 1; i < lines.length; i++) {
      const line = lines[ i ].trim();
      if (!line) {
        continue;
      }

      if (line.startsWith('### Features')) {
        currentType = 'features';
      } else if (line.startsWith('### Bug Fixes')) {
        currentType = 'fixes';
      } else if (line.startsWith('*') || line.startsWith('-')) {
        const item = line.replace(/^[*-]\s+/, '').replace(/\s+\(\[.*\]\(.*?\)\)$/, '');
        if (currentType) {
          currentVersion[ currentType ].push(item);
        } else if (version === '0.0.1' || !currentType) {
          currentVersion.features.push(item);
        }
      }
    }

    if (currentVersion.features.length > 0 || currentVersion.fixes.length > 0) {
      versions.push(currentVersion);
    }
  }
}

const tsContent = `// This file is auto-generated by scripts/sync-changelog.js
export interface ChangelogVersion {
  version: string;
  date: string;
  features?: string[];
  fixes?: string[];
}

export const changelog: ChangelogVersion[] = ${ JSON.stringify(versions, null, 2) };
`;

fs.writeFileSync(outputPath, tsContent);
console.log(`Changelog data synced to ${ outputPath }`);
